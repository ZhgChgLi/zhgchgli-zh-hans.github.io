<!doctype html><html lang="zh-cn" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="AVPlayer 本地 Cache 实作攻略｜使用 AVAssetResourceLoaderDelegate 节省 iOS 音乐串流流量" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="zh_cn" /><meta name="description" content="针对 iOS 音乐串流播放需求，实现 AVPlayer 本地 Cache 功能，避免重复下载同一档案，降低流量成本；透过自订 Resource Loader 与 PINCache 管理快取，支援分段 Range 请求与播放不中断，提升使用体验与效能。" /><meta property="og:description" content="针对 iOS 音乐串流播放需求，实现 AVPlayer 本地 Cache 功能，避免重复下载同一档案，降低流量成本；透过自订 Resource Loader 与 PINCache 管理快取，支援分段 Range 请求与播放不中断，提升使用体验与效能。" /><link rel="canonical" href="https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" /><meta property="og:url" content="https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zh-hans.zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-31T18:41:42+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zh-hans.zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" /><meta property="twitter:title" content="AVPlayer 本地 Cache 实作攻略｜使用 AVAssetResourceLoaderDelegate 节省 iOS 音乐串流流量" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://www.linkedin.com/in/zhgchgli"},"dateModified":"2024-04-13T16:45:21+08:00","datePublished":"2021-01-31T18:41:42+08:00","description":"针对 iOS 音乐串流播放需求，实现 AVPlayer 本地 Cache 功能，避免重复下载同一档案，降低流量成本；透过自订 Resource Loader 与 PINCache 管理快取，支援分段 Range 请求与播放不中断，提升使用体验与效能。","headline":"AVPlayer 本地 Cache 实作攻略｜使用 AVAssetResourceLoaderDelegate 节省 iOS 音乐串流流量","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zh-hans.zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"},"url":"https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"}</script><title>AVPlayer 本地 Cache 实作攻略｜使用 AVAssetResourceLoaderDelegate 节省 iOS 音乐串流流量 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/zh.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=false" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="https://en.zhgchg.li/posts/zrealm-dev/avplayer-local-cache-implementation-master-avassetresourceloaderdelegate-for-smooth-playback-6ce488898003/"><link rel="alternate" hreflang="ja" href="https://jp.zhgchg.li/posts/zrealm%E3%81%AE%E9%96%8B%E7%99%BA/avplayer-%E6%9C%AC%E5%9C%B0cache%E6%A9%9F%E8%83%BD%E3%81%AE%E5%AE%8C%E5%85%A8%E3%82%AC%E3%82%A4%E3%83%89-avurlasset%E3%81%A8avassetresourceloaderdelegate%E6%B4%BB%E7%94%A8%E6%B3%95-6ce488898003/"><link rel="alternate" hreflang="zh-Hant" href="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"><link rel="alternate" hreflang="zh-Hans" href="https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"><link rel="alternate" hreflang="x-default" href="https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item" style="padding:0 15px 0 15px;"> <a href="https://medium.com/@zhgchgli" class="nav-link" target="_blank" style="background:#EDF4FF;color:#0A84FF;font-size:15px;transition:background-color .2s,color .2s;" onmouseover="this.style.backgroundColor='#0A84FF';this.style.color='#ffffff';" onmouseout="this.style.backgroundColor='#EDF4FF';this.style.color='#0A84FF';"> <i class="fa-brands fa-medium"></i> <span><span style="font-size: 18px; font-weight: boild;">Follow Me on Medium!</span><br/><u>1,050+</u> Followers</span> </a><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>关于我</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>联络我</span> </a><li class="nav-item"><div aria-label="Language switch" style="display:flex;align-items:center;justify-content:center;gap:5px;"> <a href="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #ccc;background:#f3f3f3;color:#555;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 正體中文 </a> <span style="width:1px;height:18px;background:rgba(0,0,0,.12);"></span> <a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #666;background:#111;color:#fff;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 简体中文 </a></div><div aria-label="Language switch" style="display:flex;align-items:center;justify-content:center;gap:5px;margin-top:5px;"> <a href="https://en.zhgchg.li/posts/zrealm-dev/avplayer-local-cache-implementation-master-avassetresourceloaderdelegate-for-smooth-playback-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #ccc;background:#f3f3f3;color:#555;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> English </a> <span style="width:1px;height:18px;background:rgba(0,0,0,.12);"></span> <a href="https://jp.zhgchg.li/posts/zrealm%E3%81%AE%E9%96%8B%E7%99%BA/avplayer-%E6%9C%AC%E5%9C%B0cache%E6%A9%9F%E8%83%BD%E3%81%AE%E5%AE%8C%E5%85%A8%E3%82%AC%E3%82%A4%E3%83%89-avurlasset%E3%81%A8avassetresourceloaderdelegate%E6%B4%BB%E7%94%A8%E6%B3%95-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #ccc;background:#f3f3f3;color:#555;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 日本語 </a></div></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">首页</a> </span> <span>AVPlayer 本地 Cache 实作攻略｜使用 AVAssetResourceLoaderDelegate 节省 iOS 音乐串流流量</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> 文章</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜寻..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>AVPlayer 本地 Cache 实作攻略｜使用 AVAssetResourceLoaderDelegate 节省 iOS 音乐串流流量</h1><p class="post-desc fw-light mb-4">针对 iOS 音乐串流播放需求，实现 AVPlayer 本地 Cache 功能，避免重复下载同一档案，降低流量成本；透过自订 Resource Loader 与 PINCache 管理快取，支援分段 Range 请求与播放不中断，提升使用体验与效能。</p><div class="post-meta text-muted"> <span> 发布于 <time data-ts="1612089702" data-df="YYYY 年 M 月 D 日" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2021 年 01 月 31 日 </time> </span> <span> 更新于 <time data-ts="1712997921" data-df="YYYY 年 M 月 D 日" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2024 年 04 月 13 日 </time> </span><div class="mt-3 mb-3"> <a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" class="popup img-link preview-img blur"><img data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> 作者 <em> <a href="https://www.linkedin.com/in/zhgchgli">ZhgChgLi</a> </em> | <em><a href="https://www.linkedin.com/in/zhgchgli" target="_blank">Senior Software Engineer</a></em><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="7218 字" > <em>40 分钟</em>阅读</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">AVPlayer 本地 Cache 实作攻略｜使用 AVAssetResourceLoaderDelegate 节省 iOS 音乐串流流量</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章节目录 🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">AVPlayer 本地 Cache 实作攻略｜使用 AVAssetResourceLoaderDelegate 节省 iOS 音乐串流流量</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><div aria-label="Language switch" style="display:flex;align-items:center;justify-content:flex-end;"> <a href="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(220,53,69,.35);background:rgba(220,53,69,.08);color:#dc3545 !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 正體中文 </a> <a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #dc3545;background:#dc3545;color:#fff !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 简体中文 </a> <a href="https://en.zhgchg.li/posts/zrealm-dev/avplayer-local-cache-implementation-master-avassetresourceloaderdelegate-for-smooth-playback-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(220,53,69,.35);background:rgba(220,53,69,.08);color:#dc3545 !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> English </a> <a href="https://jp.zhgchg.li/posts/zrealm%E3%81%AE%E9%96%8B%E7%99%BA/avplayer-%E6%9C%AC%E5%9C%B0cache%E6%A9%9F%E8%83%BD%E3%81%AE%E5%AE%8C%E5%85%A8%E3%82%AC%E3%82%A4%E3%83%89-avurlasset%E3%81%A8avassetresourceloaderdelegate%E6%B4%BB%E7%94%A8%E6%B3%95-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(220,53,69,.35);background:rgba(220,53,69,.08);color:#dc3545 !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 日本語 </a></div><blockquote class="prompt-info"><p>基于 SEO 考量，本文标题与描述经 AI 调整，原始版本请参考内文。</p></blockquote><h4 id="zhgchgli-table-of-contents">文章目录</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li class="has-children"><details><summary>AVPlayer 实践本地 Cache 功能大全 <a href="#avplayer-实践本地-cache-功能大全">#</a></summary><ul><li><a href="#20230312-update">[2023/03/12] Update</a></li></ul></details></li><li><a href="#前言">前言</a></li><li><a href="#目标">目标</a></li><li class="has-children"><details><summary>前导知识 (1)— HTTP/1.1 Range 范围请求、Connection Keep-Alive <a href="#前导知识-1-http11-range-范围请求connection-keep-alive">#</a></summary><ul><li><a href="#http11-range-范围请求">HTTP/1.1 Range 范围请求</a></li><li><a href="#如何应用">如何应用？</a></li><li><a href="#connection-keep-alive">Connection Keep-Alive</a></li><li><a href="#如果发现伺服器不支援-range-keep-alive-">如果发现伺服器不支援 Range、 Keep-Alive ？</a></li></ul></details></li><li class="has-children"><details><summary>前导知识 (2) — AVPlayer 原生是如何处理 AVURLAsset 资源？ <a href="#前导知识-2--avplayer-原生是如何处理-avurlasset-资源">#</a></summary><ul><li><a href="#cancel-发起的时机">Cancel 发起的时机</a></li><li><a href="#avqueue-pre-buffering">AVQueue Pre-buffering</a></li></ul></details></li><li class="has-children"><details><summary>实现 <a href="#实现">#</a></summary><ul><li><a href="#进入自订的-resource-loader-的时机点">进入自订的 Resource Loader 的时机点</a></li><li><a href="#avassetresourceloaderdelegate">AVAssetResourceLoaderDelegate</a></li><li><a href="#本地-cache-实现方式">本地 Cache 实现方式</a></li></ul></details></li><li class="has-children"><details><summary>开工！ <a href="#开工">#</a></summary><ul><li><a href="#assetdata">AssetData</a></li><li><a href="#pincacheassetdatamanager">PINCacheAssetDataManager</a></li><li><a href="#cachingavurlasset">CachingAVURLAsset</a></li><li><a href="#resourceloaderrequest">ResourceLoaderRequest</a></li><li><a href="#resourceloader">ResourceLoader</a></li></ul></details></li><li class="has-children"><details><summary>补充及鸣谢 <a href="#补充及鸣谢">#</a></summary><ul><li><a href="#本篇只针对音乐小档">本篇只针对音乐小档</a></li><li><a href="#avqueueplayer-切换播放项目时取消正在下载的项目">AVQueuePlayer 切换播放项目时取消正在下载的项目</a></li><li><a href="#音讯资料加解密">音讯资料加解密</a></li><li><a href="#pincache-相关操作">PINCache 相关操作</a></li></ul></details></li><li><a href="#后记">后记</a></li><li><a href="#参考资料">参考资料</a></li><li><a href="#延伸">延伸</a></li></ul></nav><hr /><h3 id="avplayer-实践本地-cache-功能大全"><span class="me-2">AVPlayer 实践本地 Cache 功能大全</span><a href="#avplayer-实践本地-cache-功能大全" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>AVPlayer/AVQueuePlayer with AVURLAsset 实作 AVAssetResourceLoaderDelegate</p><p><a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" alt="Photo by [Tyler Lastovich](https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjQ4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Tyler Lastovich</a></p><h4 id="20230312-update"><span class="me-2">[2023/03/12] Update</span><a href="#20230312-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/ZhgChgLi/ZPlayerCacher" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/612890185/346ae563-7278-4518-a19b-f5d367e60adc" alt="" loading="lazy"></a></p><p>我将之前的实作开源了，有需求的朋友可直接使用。</p><ul><li><p>客制化 Cache 策略，可以用 PINCache or 其他…</p><li><p>外部只需呼叫 make AVAsset 工厂，带入 URL，则 AVAsset 就能支援 Caching</p><li><p>使用 Combine 实现 Data Flow 策略</p><li><p>写了一些测试</p></ul><h3 id="前言"><span class="me-2">前言</span><a href="#前言" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>既上一篇「 <a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/">iOS HLS Cache 实践方法探究之旅</a> 」后已过了大半年，团队还是一直想要实现边播边 Cache 功能因为对成本的影响极大；我们是音乐串流平台，如果每次播放同样的歌曲都要重新拿整个档案，对我们或对非吃到饱的使用者来说都很伤流量，虽然音乐档案顶多几 MB，但积沙成塔都是钱！</p><p>另外因为 Android 那边已经有实作边播边 Cache 的功能了，之前有比较过花费，Android 端上线后明显节省了许多流量；相对更多使用者的 iOS 应该能有更好的节流体现。</p><p>根据 <a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/">上一篇</a> 的经验，如果我们要继续使用 HLS ( .m3u8/.ts) 来达成目的；事情将会变得非常复杂甚至无法达成；我们退而求其次退回去使用 mp3 档，这样就能直接使用 <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> 进行实作。</p><h3 id="目标"><span class="me-2">目标</span><a href="#目标" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p>播放过的音乐会在本地产生 Cache 备份</p><li><p>播放音乐时先检查本地有无 Cache 读取，有则不再重伺服器要档案</p><li><p>可设 Cache 策略；上限总容量，超过时开始删除最旧的 Cache 档案</p><li><p>不干涉原本 AVPlayer 播放机制 （不然最快的方法就是自己先用 URLSession 把 mp3 载下来塞给 AVPlayer，但这样就失去原本能播到哪载到哪的功能，使用者需要等待更长时间＆更消耗流量）</p></ul><h3 id="前导知识-1-http11-range-范围请求connection-keep-alive"><span class="me-2">前导知识 (1)— HTTP/1.1 Range 范围请求、Connection Keep-Alive</span><a href="#前导知识-1-http11-range-范围请求connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="http11-range-范围请求"><span class="me-2">HTTP/1.1 Range 范围请求</span><a href="#http11-range-范围请求" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>首先我们要先了解在播放影片、音乐时是怎么跟伺服器要求资料的；一般来说影片、音乐档案都很大，不可能等到全部拿完才开始播放常见的是播到哪拿到了，只要有正在播放区段的资料就能运作。</p><p>要达到这个功能的方法就是透过 HTTP/1.1 Range 只返回指定资料字节范围的资料，例如指定 0–100 就只返回 0–100 这 100 bytes 大小的资料；透过这个方法，可以依序分段取得资料，然后再汇整再一起成完整的档案；这个方法也能运用在档案下载续传功能上。</p><h4 id="如何应用"><span class="me-2">如何应用？</span><a href="#如何应用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>我们会先使用 HEAD 去看 Response Header 了解到伺服器是否支援 Range 范围请求、资源总长度、档案类型：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> HEAD http://zhgchg.li/music.mp3
</pre></table></code></div></div><p><strong>使用 HEAD 我们能从 Response Header 得到以下资讯：</strong></p><ul><li><p><strong>Accept-Ranges: bytes</strong> 代表伺服器支援 Range 范围请求 如果没有 Response 这个值或是是 Accept-Ranges: none 都代表不支援</p><li><p><strong>Content-Length:</strong> 资源总长度，我们要知道总长度才能去分段要资料。</p><li><p><strong>Content-Type:</strong> 档案类型，AVPlayer 播放时需要知道的资讯。</p></ul><p>但有时我们也会使用 GET <code class="language-plaintext highlighter-rouge">Range: bytes=0–1</code> ，意思是我要求 0–1 范围的资料但实际我根本不 Care 0–1是什么内容，我只是要看 Response Header 的资讯； <strong>原生 AVPlayer 就是使用 GET 去看，所以本篇也照旧使用</strong> 。</p><blockquote><p><em>但比较建议使用 HEAD 去看，一方法比较正确，另一方面万一伺服器不支援 Range 功能；用 GET 去摸就会变强迫下载完整档案。</em></p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–1"</span>
</pre></table></code></div></div><p><strong>使用 GET 我们能从 Response Header 得到以下资讯：</strong></p><ul><li><p><strong>Accept-Ranges: bytes</strong> 代表伺服器支援 Range 范围请求 如果没有 Response 这个值或是是 Accept-Ranges: none 都代表不支援</p><li><p><strong>Content-Range: bytes 0–1/资源总长度</strong> ，「/」后的数字及资源总长度，我们要知道总长度才能去分段要资料。</p><li><p><strong>Content-Type:</strong> 档案类型，AVPlayer 播放时需要知道的资讯。</p></ul><p><a href="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijg4MiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><strong>知道伺服器支援 Range 范围请求后，就能分段发起范围请求：</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–100"</span>
</pre></table></code></div></div><p><strong>伺服器会返回 206 Partial Content：</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Content-Range: bytes 0-100/总长度
Content-Length: 100
...
(binary content)
</pre></table></code></div></div><p>这时我们就得到 Range 0–100 的 Data，可再继续发新请求拿 Range 100–200. .200–300…到结束。</p><p>如果拿的 Range 超过资源总长度会返回 416 Range Not Satisfiable。</p><p>另外，想拿完整档案资料除了可以请求 Range 0-总长度，也可以使用 0- 方式即可：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–"</span>
</pre></table></code></div></div><p>其他还可以同个请求要求多个 Range 资料及下条件式子，但我们用不到，详情可 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Range_requests" target="_blank">参考这</a> 。</p><h4 id="connection-keep-alive"><span class="me-2">Connection Keep-Alive</span><a href="#connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>http 1.1 预设是开启状态， <strong>此特性能实时取得已下载的资料</strong> ，例如档案 5 mb，能 16 kb、16 kb、16 kb… 的取得，不用等到 5mb 都好才给你。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Connection: Keey-Alive
</pre></table></code></div></div><h4 id="如果发现伺服器不支援-range-keep-alive-"><span class="me-2"><strong><em>如果发现伺服器不支援 Range、</em></strong> Keep-Alive <strong><em>？</em></strong></span><a href="#如果发现伺服器不支援-range-keep-alive-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><em>那也不用搞这么多了，直接自己用 URLSession 下载完 mp3 档案塞给播放器就好….但这不是我们要的结果，可以请后端帮忙修改伺服器设定。</em></p></blockquote><h3 id="前导知识-2--avplayer-原生是如何处理-avurlasset-资源"><span class="me-2">前导知识 (2) — AVPlayer 原生是如何处理 AVURLAsset 资源？</span><a href="#前导知识-2--avplayer-原生是如何处理-avurlasset-资源" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjY1IiBoZWlnaHQ9Ijc5MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>当我们使用 AVURLAsset init with URL 资源并赋予给 AVPlayer/AVQueuePlayer 开始播放之后，同上所述，首先会用 GET Range 0–1 去取得是否支援 Range 范围请求、资源总长度、档案类型这三个资讯。</p><p>有了档案资讯后，会再发起第二次请求，请求从 0-总长度 的资料。</p><blockquote><p><em>⚠️ <strong>AVPlayer 会请求从 0-总长度 的资料，并透过实时取得已下载的资料特性 (</strong> 16 kb、16 kb、16 kb…) <strong>取得到他觉得资料足够后，会发起 Cancel 取消这个网路请求</strong> （所以实际也不会拿完，除非档案太小）。</em></p></blockquote><blockquote><p><em>继续播放后才会透过 Range 往后请求资料。</em></p></blockquote><blockquote><p><em>（这部分跟我之前想的不一样，我以为会是0–100、100–200. .这样请求）</em></p></blockquote><p><strong>AVPlayer 请求范例：</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>1. GET Range 0-1 =&gt; Response: 总长度 150000 / public.mp3 / true
2. GET 0-150000...
3. 16 kb receive
4. 16 kb receive...
5. cancel() // current offset is 700
6. 继续播放
7. GET 700-150000...
8. 16 kb receive
9. 16 kb receive...
10. cancel() // current offset is 1500
11. 继续播放
12. GET 1500-150000...
13. 16 kb receive
14. 16 kb receive...
16. If seek to...5000
17. cancel(12.) // current offset is 2000
18. GET 5000-150000...
19. 16 kb receive
20. 16 kb receive...
...
</pre></table></code></div></div><blockquote><p><em>⚠️ <strong>iOS ≤12 的情况下，会先发几个较短的请求试著摸摸看（？然后才会发要求到总长度的请求； iOS ≥ 13 则会直接发要求到总长度的请求。</strong></em></p></blockquote><p>还有个题外的坑，就是在观察怎么拿资源的时候，我使用了 <a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/app-https%E4%BC%A0%E8%BE%93%E4%BB%8D%E9%81%AD%E7%AA%83%E5%8F%96-mitmproxy%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB%E5%AE%9E%E6%88%98%E6%95%99%E5%AD%A6%E4%B8%8E%E9%98%B2%E8%8C%83%E6%8A%80%E5%B7%A7-46410aaada00/">mitmproxy</a> 工具嗅探，结果发现它显示有错，会等到 response 全部回来才会显示，而不是显示分段、使用持久连接接续下载；害我吓了一大跳！以为 iOS 很笨居然每次都要整个档案回来！下次要用工具时要有保持一点怀疑 Orz</p><h4 id="cancel-发起的时机"><span class="me-2">Cancel 发起的时机</span><a href="#cancel-发起的时机" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>前面说到的第二次请求，请求从 0 开始 到总长度的资源，有足够 Data 后会发起 Cancel 取消请求。</p><li><p>Seek 时会先发起 Cancel 取消先前的请求。</p></ol><blockquote><p><em>⚠️ 在 AVQueuePlayer 中切换到下一个资源、AVPlayer 更换播放资源时并不会发起 Cancel 取消前一首的请求。</em></p></blockquote><h4 id="avqueue-pre-buffering"><span class="me-2">AVQueue Pre-buffering</span><a href="#avqueue-pre-buffering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>其实也是同样呼叫 Resource Loader 处理，只是他要求的资料范围会比较小。</p><h3 id="实现"><span class="me-2">实现</span><a href="#实现" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>有了以上前导知识后我们来看实现 AVPlayer 本地 Cache 功能的原理方式。</p><p>就是之前有提到的 <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> ，这个接口让我们能 <strong>自行实践 Resource Loader</strong> 给 Asset 用。</p><p>Resource Loader 实际就是个打工仔，播放器是要档案资讯还是档案资料，范围哪里都哪里都是他告诉我们，我们去做就是。</p><blockquote><p><em>看到有范例是一个 <strong>Resource Loader 服务所有 AVURLAsset</strong> ，我觉得是错的，应该要一个 Resource Loader 服务一个 AVURLAsset，跟著 AVURLAsset 的生命周期，他本来就属于 AVURLAsset。</em></p></blockquote><blockquote><p><em>一个 Resource Loader 服务所有 AVURLAsset 在 AVQueuePlayer 上会变得非常复杂且难以管理。</em></p></blockquote><h4 id="进入自订的-resource-loader-的时机点"><span class="me-2">进入自订的 Resource Loader 的时机点</span><a href="#进入自订的-resource-loader-的时机点" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>要注意的是不是实践了自己的 Resource Loader 他就会理你，只有当系统无法辨识处理这个资源的时候，才会走你的 Resource Loader。</p><p>所以我们在将 URL 资源给予 AVURLAsset 之前要先将 Scheme 换成我们自订的 Scheme，不能是 http/https… 这些系统能处理的 Scheme。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://zhgchg.li/music.mp3 =&gt; cacheable://zhgchg.li/music.mp3
</pre></table></code></div></div><h4 id="avassetresourceloaderdelegate"><span class="me-2"><code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code></span><a href="#avassetresourceloaderdelegate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>只有两个方法需要实现：</strong></p><ul><li>func resourceLoader( _ resourceLoader: AVAssetResourceLoader, shouldWaitForLoadingOfRequestedResource <strong>loadingRequest</strong> : AVAssetResourceLoadingRequest) -&gt; Bool :</ul><p>此方法问我们能不能处理此资源，return true 能，return false 我们也不处理（unsupported url）。</p><p>我们能从 <code class="language-plaintext highlighter-rouge">loadingRequest</code> 取出要请求什么（第一次请求档案资讯还是请求资料，请求资料的话 Range 是多少到多少）；知道请求后我们自行发起请求去拿资料， <strong>在这我们就能决定要发起 URLSession 还是从本地返回 Data</strong> 。</p><p>另外也能在此做 Data 加解密操作，保护原始资料。</p><ul><li>func resourceLoader( _ resourceLoader: AVAssetResourceLoader, didCancel <strong>loadingRequest</strong> : AVAssetResourceLoadingRequest) :</ul><p>前述说到的 <strong>Cancel 发起时机</strong> 发起 Cancel 时…</p><p>我们可以在这去取消正在请求的 URLSession。</p><p><a href="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDYwIiBoZWlnaHQ9Ijk0MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="本地-cache-实现方式"><span class="me-2">本地 Cache 实现方式</span><a href="#本地-cache-实现方式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Cache 的部分我直接使用 <a href="https://github.com/pinterest/PINCache" target="_blank">PINCache</a> ，将 Cache 工作交由他处理，免去我们要处理 Cache 读写 DeadLock、清除 Cache LRU 策略 实作上的问题。</p><blockquote><p><strong><em>️️⚠️️️️️️️️️️️OOM警告！</em></strong></p></blockquote><blockquote><p><em>因为这边是针对音乐做 Cache 档案大小顶多 10 MB 上下，所以才能使用 PINCache 作为本地 Cache 工具；如果是要服务影片就无法使用此方法（可能一次要载入好几 GB 的资料到记忆体）</em></p></blockquote><p>有这部分需求可参考大大的做法，用 FileHandle seek read/write 的特性进行处理。</p><h3 id="开工"><span class="me-2">开工！</span><a href="#开工" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>不啰唆，先上完整专案：</p><p><a href="https://github.com/zhgchgli0718/resourceLoaderDemo" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/b43d0ddf4687cf5a04d6bbc68e4bfd24a9d5067fe04e2e198a676aff746de403/zhgchgli0718/resourceLoaderDemo" alt="" loading="lazy"></a></p><h4 id="assetdata"><span class="me-2">AssetData</span><a href="#assetdata" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>本地 Cache 资料物件映射实现 NSCoding，因 PINCache 是依赖 archivedData 方法 encode/decode。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CryptoKit</span>

<span class="kd">class</span> <span class="kt">AssetDataContentInformation</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentLength</span><span class="p">:</span> <span class="kt">Int64</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentType</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">isByteRangeAccessSupported</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>
    
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentLength</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentLength</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentType</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentType</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeInt64</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentLength</span><span class="p">))</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentType</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">??</span> <span class="s">""</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Bool</span> <span class="p">??</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">mediaData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">AssetDataContentInformation</span> <span class="p">??</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">??</span> <span class="kt">Data</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">AssetData</code> <strong>存放：</strong></p><ul><li><p><code class="language-plaintext highlighter-rouge">contentInformation</code> : AssetDataContentInformation <code class="language-plaintext highlighter-rouge">AssetDataContentInformation</code> ： 存放 是否支援 Range 范围请求(isByteRangeAccessSupported)、资源总长度(contentLength)、档案类型(contentType)</p><li><p><code class="language-plaintext highlighter-rouge">mediaData</code> : 原始音讯 Data <strong>（这边档案太大会 OOM）</strong></p></ul><h4 id="pincacheassetdatamanager"><span class="me-2">PINCacheAssetDataManager</span><a href="#pincacheassetdatamanager" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>封装 Data 存入、取出 PINCache 逻辑。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">PINCache</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">protocol</span> <span class="kt">AssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span>
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="n">offset</span>
            <span class="k">var</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">from</span>
            <span class="n">data</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">with</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">start</span><span class="o">..&lt;</span><span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>

<span class="kd">class</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">Cache</span><span class="p">:</span> <span class="kt">PINCache</span> <span class="o">=</span> <span class="kt">PINCache</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"ResourceLoader"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">cacheKey</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">AssetData</span><span class="p">()</span>
        <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">contentInformation</span>
        <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">mediaData</span>
            
            <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">object</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">AssetData</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">assetData</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>这边多抽出 Protocol 因为未来可能使用其他储存方式替代 PINCache，所以其他程式在使用时是依赖 Protocol 而非 Class 实体。</p><blockquote><p><em>⚠️ <code class="language-plaintext highlighter-rouge">mergeDownloadedDataIfIsContinuted</code> <strong>这个方法极其重要。</strong></em></p></blockquote><p>照线性播放只要一直 append 新 Data 到 Cache Data 中即可，但现实情况复杂得多，使用者可能播了 Range 0~100，直接 Seek 到 Range 200–500 播放；如何将已有的 0-100 Data 与新的 200–500 Data 合并就是一个很大的问题。</p><blockquote><p><em>⚠️Data 合并有问题会出现可怕的播放鬼畜问题….</em></p></blockquote><p>这边的答案是， <strong>我们不处理非连续资料</strong> ；因为敝专案仅为音讯，档案也就几 MB (≤ 10MB) 以考量开发成本就没做了，我只处理合并连续的资料（例如目前已有 0~100，新资料是 75~200，合并之后变0~200；如果新资料是 150~200，我则会忽略不合并处理）</p><p><a href="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijc4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>如果要考虑非连续合并，除了在储存上要使用其他方法（要有办法辨识空缺部分）；在 Request 时也要能 Query 出哪段需要发网路请求去拿、哪段是从本地拿；要考量到这情况实作会非常复杂。</p><p><a href="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.webp" alt="图片取自： [iOS AVPlayer 视频缓存的设计与实现](http://chuquan.me/2019/12/03/ios-avplayer-support-cache/){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iMjQ1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>图片取自： <a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">iOS AVPlayer 视频缓存的设计与实现</a></p><h4 id="cachingavurlasset"><span class="me-2">CachingAVURLAsset</span><a href="#cachingavurlasset" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>AVURLAsset 是 weak 持有 ResourceLoader Delegate，所以这边建议自己建立一个 AVURLAsset Class 继承自 AVURLAsset，在内部建立、赋予、持有 ResourceLoader ，让他跟著 AVURLAsset 的生命周期；另外也可以储存原始 URL、CacheKey 等资讯…。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">CachingAVURLAsset</span><span class="p">:</span> <span class="kt">AVURLAsset</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">customScheme</span> <span class="o">=</span> <span class="s">"cacheable"</span>
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_resourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoader</span><span class="p">?</span>
    
    <span class="k">var</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">lastPathComponent</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">_</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="s">"http"</span><span class="p">,</span> <span class="s">"https"</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">(</span><span class="n">url</span> <span class="kt">URL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="kt">URL</span>
        
        <span class="k">guard</span> <span class="k">var</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">components</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="n">customScheme</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
        
        <span class="k">let</span> <span class="nv">resourceLoader</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">resourceLoader</span><span class="o">.</span><span class="nf">setDelegate</span><span class="p">(</span><span class="n">resourceLoader</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="n">resourceLoader</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_resourceLoader</span> <span class="o">=</span> <span class="n">resourceLoader</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>使用：</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">asset</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
  <span class="k">let</span> <span class="nv">avplayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
  <span class="n">avplayer</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>其中 <code class="language-plaintext highlighter-rouge">isSchemeSupport()</code> 是用来判断 URL 是否支援挂我们的 Resource Loader（排除 file:// ）。</p><p><code class="language-plaintext highlighter-rouge">originalURL</code> 存放原始资源 URL。</p><p><code class="language-plaintext highlighter-rouge">cacheKey</code> 存放这个资源的 Cache Key，这边直接用档案名称当 Cache Key。</p><p><code class="language-plaintext highlighter-rouge">cacheKey</code> 请依照现实场景做调整，如果档案名称未 hash 可能重复就建议先 hash 后当 key 避免碰撞；如果要 hash 整个 URL 当 key 也要注意 URL 是否会变动 (例如有用 CDN)。</p><p>Hash 可使用 md5…sha. .，iOS ≥ 13 可直接使用 Apple 的 <a href="https://developer.apple.com/documentation/cryptokit/" target="_blank">CryptoKit</a> ，其他就上 Github 找吧！</p><h4 id="resourceloaderrequest"><span class="me-2">ResourceLoaderRequest</span><a href="#resourceloaderrequest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">protocol</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ResourceLoaderRequest</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">URLSessionDataDelegate</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">start</span><span class="p">:</span> <span class="kt">Int64</span>
        <span class="k">var</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">RequestRangeEnd</span>
        
        <span class="kd">enum</span> <span class="kt">RequestRangeEnd</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nf">requestTo</span><span class="p">(</span><span class="kt">Int64</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">requestToEnd</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">enum</span> <span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">contentInformation</span>
        <span class="k">case</span> <span class="n">dataRequest</span>
    <span class="p">}</span>
    
    <span class="kd">struct</span> <span class="kt">ResponseUnExpectedError</span><span class="p">:</span> <span class="kt">Error</span> <span class="p">{</span> <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span>
    
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isCancelled</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isCancelled</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">invalidateAndCancel</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isFinished</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isFinished</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">finishTasksAndInvalidate</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">?</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">originalURL</span>
        <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span> <span class="o">=</span> <span class="n">loaderQueue</span>
        <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span> <span class="o">=</span> <span class="n">assetDataManager</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">isCancelled</span> <span class="o">==</span> <span class="kc">false</span><span class="p">,</span> <span class="n">isFinished</span> <span class="o">==</span> <span class="kc">false</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            
            <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span> <span class="o">=</span> <span class="n">requestRange</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">requestRange</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">String</span>
            <span class="k">switch</span> <span class="n">requestRange</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">rangeEnd</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="s">""</span>
            <span class="p">}</span>
            
            <span class="k">let</span> <span class="nv">rangeHeader</span> <span class="o">=</span> <span class="s">"bytes=</span><span class="se">\(</span><span class="n">start</span><span class="se">)</span><span class="s">-</span><span class="se">\(</span><span class="n">end</span><span class="se">)</span><span class="s">"</span>
            <span class="n">request</span><span class="o">.</span><span class="nf">setValue</span><span class="p">(</span><span class="n">rangeHeader</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Range"</span><span class="p">)</span>
            
            <span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">,</span> <span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">delegateQueue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
            <span class="k">let</span> <span class="nv">dataTask</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span> <span class="o">=</span> <span class="n">dataTask</span>
            <span class="n">dataTask</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isCancelled</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">dataRequest</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">URLSession</span><span class="o">.</span><span class="kt">ResponseDisposition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="nf">completionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isFinished</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="k">guard</span> <span class="n">error</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span>
                      <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="k">as?</span> <span class="kt">HTTPURLResponse</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">responseError</span> <span class="o">=</span> <span class="n">error</span> <span class="p">??</span> <span class="kt">ResponseUnExpectedError</span><span class="p">()</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">responseError</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="p">}</span>
                
                <span class="k">let</span> <span class="nv">contentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Content-Range"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytesString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytes</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">bytesString</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">bytes</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Accept-Ranges"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="n">value</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">true</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">false</span>
                <span class="p">}</span>
                
                <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">)</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">))</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">offset</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span><span class="p">?</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveDownloadedData</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>针对 Remote Request 的封装，主要是服务 ResourceLoader 发起的资料请求。</p><p><code class="language-plaintext highlighter-rouge">RequestType</code> ：用来区分此 Request 是 第一次请求档案资讯(contentInformation)、还是请求资料(dataRequest)</p><p><code class="language-plaintext highlighter-rouge">RequestRange</code> ：请求 Range 范围，end 可指定到哪(requestTo(Int64) )或全部(requestToEnd)。</p><p>档案资讯可由：</p><pre><code class="language-less">func urlSession(_ session: URLSession, dataTask: URLSessionDataTask, didReceive response: URLResponse, completionHandler: @escaping (URLSession.ResponseDisposition) -&gt; Void)
</code></pre><p>中取得 Response Header，另外要注意如果要改 HEAD 去摸，不会进这个要用其他方法接。</p><ul><li><p><code class="language-plaintext highlighter-rouge">isByteRangeAccessSupported</code> ：看 Response Header 中的 <strong>Accept-Ranges == bytes</strong></p><li><p><code class="language-plaintext highlighter-rouge">contentType</code> ：播放器要的档案类型资讯，格式是统一类识别符，不是 audio/mpeg ，而是写作 public.mp3</p><li><p><code class="language-plaintext highlighter-rouge">contentLength</code> ：看 Response Header 中的 <strong>Content-Range</strong> ：bytes 0–1/ <strong>资源总长度</strong></p></ul><blockquote><p><em>⚠️这边要注意伺服器给的格式大小写，不一定是写作 Accept-Ranges/Content-Range；有的伺服器的格式是小写 accept-ranges、Accept-ranges…</em></p></blockquote><p><strong>补充：如果要考量大小写可以写 HTTPURLResponse Extension</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">extension</span> <span class="kt">HTTPURLResponse</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">parseContentLengthFromContentRange</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Int64</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Content-Range"</span><span class="p">,</span>
            <span class="s">"content-range"</span><span class="p">,</span>
            <span class="s">"Content-range"</span><span class="p">,</span>
            <span class="s">"content-Range"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLengthString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLength</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">contentLengthString</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentLength</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parseAcceptRanges</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Bool</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Accept-Ranges"</span><span class="p">,</span>
            <span class="s">"accept-ranges"</span><span class="p">,</span>
            <span class="s">"Accept-ranges"</span><span class="p">,</span>
            <span class="s">"accept-Ranges"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="p">\\</span><span class="o">|</span><span class="p">\\</span><span class="o">|</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"Bytes"</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">mimeTypeUTI</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
           <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>使用：</p><ul><li><p>contentLength = response.parseContentLengthFromContentRange( )</p><li><p>isByteRangeAccessSupported = response.parseAcceptRanges( )</p><li><p>contentType = response.mimeTypeUTI( )</p></ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
</pre></table></code></div></div><p>同前导知识所述，会实时取得已下载的资料，所以这个方法会一直进，片段片段的拿到 Data；我们将他 append 进 <code class="language-plaintext highlighter-rouge">downloadedData</code> 存放。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span>
</pre></table></code></div></div><p>任务取消或结束时都会进这个方法，在这将已下载的资料保存下来。</p><p>如前导知识中提到的 Cancel 机制，因播放器在拿到足够资料后就会发起 Cancel，Cancel Request；所以进到这个方法时实际会是 <code class="language-plaintext highlighter-rouge">error = NSURLErrorCancelled</code> ，因此不管 error 我们有拿到资料都会尝试存下来。</p><blockquote><p><em>⚠️ 因 URLSession 会用并行方式出去请求资料，所以请保持操作都在DispatchQueue里，避免资料错乱(资料错乱一样会出现可怕的播放鬼畜)。</em></p></blockquote><blockquote><p><em>️️⚠️URLSession 没有呼叫 <code class="language-plaintext highlighter-rouge">finishTasksAndInvalidate</code> 或 <code class="language-plaintext highlighter-rouge">invalidateAndCancel</code> 两个方法都会强持有物件导致 Memory Leak；所以不管是取消或是完成我们都要呼叫，这样才能在任务结束释放 Request。</em></p></blockquote><blockquote><p><em>️️⚠️️️️️️️️️️️如果怕 <code class="language-plaintext highlighter-rouge">downloadedData</code> OOM，可以在 didReceive Data 中就存入本地。</em></p></blockquote><h4 id="resourceloader"><span class="me-2">ResourceLoader</span><a href="#resourceloader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">AVFoundation</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">class</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">loaderQueue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.resourceLoader.queue"</span><span class="p">)</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="kt">CachingAVURLAsset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">cacheKey</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">originalURL</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">request</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoaderDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        
        <span class="k">let</span> <span class="nv">type</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">assetDataManager</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="n">assetDataManager</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">Int64</span>
                    <span class="k">switch</span> <span class="n">range</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">rangeEnd</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                    <span class="p">}</span>
                    
                    <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="p">{</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="kt">Int</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                       <span class="k">return</span> <span class="kc">true</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">range</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
                        <span class="c1">// has cache data...but not enough</span>
                        <span class="k">let</span> <span class="nv">subEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">?</span> <span class="kt">Int</span><span class="p">((</span><span class="n">end</span><span class="p">))</span> <span class="p">:</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="n">subEnd</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="kt">ResourceLoaderRequest</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="n">type</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="n">assetDataManager</span><span class="p">)</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="o">=</span> <span class="n">resourceLoaderRequest</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">contentInformation</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">_</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">contentInformation</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">dataRequest</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">_</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span><span class="p">,</span> <span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestsAllDataToEndOfResource</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="n">requestToEnd</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">let</span> <span class="nv">length</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestedLength</span> <span class="p">??</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">let</span> <span class="nv">upperBound</span> <span class="o">=</span> <span class="n">lowerBound</span> <span class="o">+</span> <span class="n">length</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="n">upperBound</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest</code> != nil 则代表是第一次请求，播放器要求先给档案资讯。</p><p>请求档案资讯时我们需要赋予这三项资讯：</p><ul><li><p><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.isByteRangeAccessSupported</code> ：是否支援 Range 拿 Data</p><li><p><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentType</code> ：统一类识别符</p><li><p><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentLength</code> ：档案总长度 Int64</p></ul><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedOffset</code> 可取得要求 Range 的起始 offset。</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedLength</code> 可取得要求 Range 的长度。</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestsAllDataToEndOfResource</code> == true 则不管要求 Range 的长度，直接拿到底。</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.respond(with: Data)</code> 返回已载入的 Data 给播放器。</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.currentOffset</code> 可取得当前 data offset， <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code> 后 <code class="language-plaintext highlighter-rouge">currentOffset</code> 会跟著推移。</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.finishLoading()</code> 资料都载完了，告知播放器。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
</pre></table></code></div></div><p>播放器请求资料，我们先看本地 Cache 有无资料，有则返回；若只有部分资料则一样返回部分，例如我本地有 0–100 ，播放器要求 0–200，则先返回 0–100。</p><p>若没有本地 Cache、返回的资料不够，则会发起 ResourceLoaderRequest 请求从网路拿资料。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span>
</pre></table></code></div></div><p>播放器取消请求，取消 ResourceLoaderRequest。</p><blockquote><p><em>你可能有发现</em> <code class="language-plaintext highlighter-rouge">resourceLoaderRequestRange</code> <em>的 offset 是看 <code class="language-plaintext highlighter-rouge">currentOffset</code> ，因为我们会先从本地 <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code> 已下载 Data；所以直接看推移后的 offset 即可。</em></p></blockquote><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
</pre></table></code></div></div><blockquote><p><em>⚠️ requests 有的范例是只用 <code class="language-plaintext highlighter-rouge">currentRequest: ResourceLoaderRequest</code> 来存放，这会有个问题，因为可能当前的 request 正在拿取，使用者又 seek 这时会取消旧的发起新的；但因不一定会照顺序发生，可能先走发新请求再走取消；所以用 Dictionary 去存取操作还是比较安全！</em></p></blockquote><blockquote><p><em>⚠️让所有操作都在同个 DispatchQueue 防止出现资料鬼畜。</em></p></blockquote><p><strong>deinit 时取消所有还在请求的 requests</strong> Resource Loader Deinit 即代表 AVURLAsset Deinit，代表播放器已经不需要这个资源了；所以我们可以 Cancel 还在取资料的 Request，已经载的一样会写入 Cache。</p><h3 id="补充及鸣谢"><span class="me-2">补充及鸣谢</span><a href="#补充及鸣谢" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>感谢 <a href="https://medium.com/u/2d01a2439753" target="_blank">Lex 汤</a> 大大指点。</p><p>感谢 <a href="https://medium.com/u/aab116fd9d4d" target="_blank">外孙女</a> 提供开发上的意见及支持。</p><h4 id="本篇只针对音乐小档"><span class="me-2">本篇只针对音乐小档</span><a href="#本篇只针对音乐小档" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>影片大档案可能会在 downloadedData、AssetData/PINCacheAssetDataManager 发生 Out Of Memory 问题。</p><p>同前述，如果要解决这个问题请使用 fileHandler seek read/wirte 去操作本地 Cache 读取写入（取代AssetData/PINCacheAssetDataManager）；或找看看 Github 有没有大 data write/read to file 的专案可用。</p><h4 id="avqueueplayer-切换播放项目时取消正在下载的项目"><span class="me-2">AVQueuePlayer 切换播放项目时取消正在下载的项目</span><a href="#avqueueplayer-切换播放项目时取消正在下载的项目" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>同前导知识中所述，在更换播放目标时是不会发起 Cancel 的；如果是 AVPlayer 会走 AVURLAsset Deinit 所以下载也会中断；但 AVQueuePlayer 不会，因为都还在 Queue 里，只是播放目标换到下一首而已。</p><p>这边唯一做法就只能接收变换播放目标通知，然后在收到通知后取消上一手的 AVURLAsset loading。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">asset</span><span class="o">.</span><span class="nf">cancelLoading</span><span class="p">()</span>
</pre></table></code></div></div><h4 id="音讯资料加解密"><span class="me-2">音讯资料加解密</span><a href="#音讯资料加解密" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>音讯加解密可在 ResourceLoaderRequest 中拿到 Data 进行、还有储存时能在 AssetData 的 encode/decode 对存在本地的 Data进行加解密。</p><p><strong>CryptoKit SHA 使用范本：</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">encryptionKeyString</span> <span class="o">=</span> <span class="s">"encryptionKeyExzhgchgli"</span>
    <span class="o">...</span>
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="k">#available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="o">*</span><span class="p">),</span>
           <span class="k">let</span> <span class="nv">encryptionData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">seal</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span><span class="o">.</span><span class="n">combined</span> <span class="p">{</span>
            <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">encryptionData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">#available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="o">*</span><span class="p">),</span>
               <span class="k">let</span> <span class="nv">sealedBox</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="kt">SealedBox</span><span class="p">(</span><span class="nv">combined</span><span class="p">:</span> <span class="n">mediaData</span><span class="p">),</span>
               <span class="k">let</span> <span class="nv">decryptedData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">open</span><span class="p">(</span><span class="n">sealedBox</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">decryptedData</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">//</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="pincache-相关操作"><span class="me-2">PINCache 相关操作</span><a href="#pincache-相关操作" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>PINCache 包含 PINMemoryCache 和 PINDiskCache，PINCache 会帮我们处理从档案读到 Memory 或从 Memory 写入档案的事，我们只需要对 PINCache 进行操作。</p><p>在模拟器中查找 Cache 档案位置：</p><p><a href="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NzgiIGhlaWdodD0iOTIiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>使用 <code class="language-plaintext highlighter-rouge">NSHomeDirectory()</code> 取得模拟器档案路径</p><p><a href="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjU0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Finder -&gt; 前往 -&gt; 贴上路径</p><p><a href="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjU0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>在 Library -&gt; Caches -&gt; com.pinterest.PINDiskCache.ResourceLoader 就是我们建的 Resource Loader Cache 目录。</p><p><code class="language-plaintext highlighter-rouge">PINCache(name: “ResourceLoader”)</code> 其中的 name 就是目录名称。</p><p>也可以指定 rootPath ，目录就可以改到 Documents 底下（不怕被系统清掉）。</p><p><strong>设定 PINCache 最大上限：</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteCount</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="c1">// max: 300mb</span>
 <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteLimit</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="c1">// 90 days</span>
</pre></table></code></div></div><p><a href="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.webp" alt="系统预设上限" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMzYiIGhlaWdodD0iODkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>系统预设上限</p><p>设 0 的话就不会主动删除档案。</p><h3 id="后记"><span class="me-2">后记</span><a href="#后记" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>原先太小看这个功能的困难度，以为三两下就能处理好；结果吃尽苦头，大概又多花了两周处理资料储存的问题，不过也就此彻底了解整个 Resource Loader 运作机制、 GCD 、Data。</p><h3 id="参考资料"><span class="me-2">参考资料</span><a href="#参考资料" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>最后附上研究如何实作的参考资料</p><ol><li><p><a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">iOS AVPlayer 视频缓存的设计与实现</a> 仅讲原理</p><li><p><a href="https://caisanze.com/post/swift-avplayer/" target="_blank">基于AVPlayer实现音视频播放和缓存，支持视频画面的同步输出</a> [ <a href="https://github.com/eroscai/SZAVPlayer" target="_blank">SZAVPlayer</a> ] 有附程式（很完整，但很复杂）</p><li><p><a href="https://github.com/neekeetab/CachingPlayerItem/blob/7d998b8561693cf51077f0891ed240e92bec415e/CachingPlayerItem.swift" target="_blank">CachingPlayerItem</a> （简易实现，较好懂但不完整）</p><li><p><a href="https://www.jianshu.com/p/28157247d6a7" target="_blank">可能是目前最好的 AVPlayer 音视频缓存方案 AVAssetResourceLoaderDelegate</a></p><li><p><a href="https://sshiqiao.github.io/document/douyin-swift.html#1" target="_blank">仿抖音 Swift 版</a> [ <a href="https://github.com/sshiqiao/douyin-ios-swift" target="_blank">Github</a> ]（蛮有意思的专案，复刻抖音 APP；里面也有用到 Resource Loader）</p><li><p><a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/">iOS HLS Cache 实践方法探究之旅</a></p></ol><h3 id="延伸"><span class="me-2">延伸</span><a href="#延伸" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://github.com/dminoror/DLCachePlayer" target="_blank">DLCachePlayer</a> (Objective-C 版)</ul><p>有任何问题及指教欢迎 <a href="https://www.zhgchg.li/contact" target="_blank">与我联络</a> 。</p><script src="/assets/clipboard.min.js"></script><div style=" display:flex; align-items:center; gap:10px; border:1px solid #e5e7eb; background:#f9fafb; padding:12px 16px; border-radius:12px; margin:18px 0; box-shadow:0 3px 8px rgba(0,0,0,0.05); width: auto;"> <input id="share-url" value="https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" readonly="" style=" flex:1; border:1px solid #d1d5db; border-radius:8px; padding:10px 12px; font-size:0.9rem; background:#ffffff; color:#111827; outline:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; " /> <button class="btn" data-clipboard-target="#share-url" id="copy-btn" style=" border:none; background:#3b82f6; color:white; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:0.85rem; font-weight:600; display:flex; align-items:center; gap:6px; transition:all .15s ease; box-shadow:0 2px 5px rgba(59,130,246,0.35); " onmouseover="this.style.opacity='0.92';" onmouseout="this.style.opacity='1';"> <span style="font-size:1rem;">🔗</span> <span id="copy-btn-text">Copy link to share!</span> </button></div><script> new ClipboardJS('.btn'); var btn = document.getElementById("copy-btn"); var text = document.getElementById("copy-btn-text"); btn.addEventListener("click", function () { text.textContent = "Copied!"; btn.style.background = "#16a34a"; btn.style.boxShadow = "0 2px 6px rgba(22,163,74,0.35)"; setTimeout(() => { text.textContent = "Copy link to share!"; btn.style.background = "#3b82f6"; btn.style.boxShadow = "0 2px 5px rgba(59,130,246,0.35)"; }, 1500); });</script><hr /><p><a href="https://www.paypal.com/ncp/payment/CMALMPT8UUTY2" target="_blank" rel="noopener" style="display:block;margin:12px 0;text-align:center;align-items:center;justify-content:center;padding:10px 22px;border-radius:999px;text-decoration:none;background:linear-gradient(135deg,#ffd54f,#ffb300);color:#000;font-size:16px;font-weight:700;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;box-shadow:0 4px 10px rgba(0,0,0,.15);cursor:pointer;transition:all .15s ease;width:350px" onmouseover="this.style.background=&quot;linear-gradient(135deg,#FFE082,#FFC107)&quot;,this.style.transform=&quot;translateY(-1px)&quot;,this.style.boxShadow=&quot;0 6px 14px rgba(0,0,0,0.2)&quot;" onmouseout="this.style.background=&quot;linear-gradient(135deg,#FFD54F,#FFB300)&quot;,this.style.transform=&quot;translateY(0)&quot;,this.style.boxShadow=&quot;0 4px 10px rgba(0,0,0,0.15)&quot;">🍺 Buy me a beer on PayPal</a></p><blockquote class="prompt-tip"><p>👉👉👉 <a href="https://medium.com/@zhgchgli" target="_blank"><strong>Follow Me On Medium!</strong> (1,050+ Followers)</a> 👈👈👈</p></blockquote><blockquote class="prompt-info"><p>本文首次发表于 Medium (<a href="https://medium.com/p/6ce488898003" target="_blank"><strong>点击查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自动转换与同步技术。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-cn/zmediumtomarkdown/2021-01-31-6ce488898003.md" target="_blank">Improve this page on Github.</a></p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/simplified-chinese/" class="post-tag no-text-decoration" >simplified-chinese</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/cache/" class="post-tag no-text-decoration" >cache</a> <a href="/tags/avplayer/" class="post-tag no-text-decoration" >avplayer</a> <a href="/tags/music-player-app/" class="post-tag no-text-decoration" >music-player-app</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> 本文由作者以 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh-hans"> CC BY 4.0 </a> 授权。</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AVPlayer%20%E6%9C%AC%E5%9C%B0%20Cache%20%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5%EF%BD%9C%E4%BD%BF%E7%94%A8%20AVAssetResourceLoaderDelegate%20%E8%8A%82%E7%9C%81%20iOS%20%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzh-hans.zhgchg.li%2Fposts%2Fzrealm-dev%2Favplayer-%25E6%259C%25AC%25E5%259C%25B0-cache-%25E5%25AE%259E%25E4%25BD%259C%25E6%2594%25BB%25E7%2595%25A5-%25E4%25BD%25BF%25E7%2594%25A8-avassetresourceloaderdelegate-%25E8%258A%2582%25E7%259C%2581-ios-%25E9%259F%25B3%25E4%25B9%2590%25E4%25B8%25B2%25E6%25B5%2581%25E6%25B5%2581%25E9%2587%258F-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AVPlayer%20%E6%9C%AC%E5%9C%B0%20Cache%20%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5%EF%BD%9C%E4%BD%BF%E7%94%A8%20AVAssetResourceLoaderDelegate%20%E8%8A%82%E7%9C%81%20iOS%20%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzh-hans.zhgchg.li%2Fposts%2Fzrealm-dev%2Favplayer-%25E6%259C%25AC%25E5%259C%25B0-cache-%25E5%25AE%259E%25E4%25BD%259C%25E6%2594%25BB%25E7%2595%25A5-%25E4%25BD%25BF%25E7%2594%25A8-avassetresourceloaderdelegate-%25E8%258A%2582%25E7%259C%2581-ios-%25E9%259F%25B3%25E4%25B9%2590%25E4%25B8%25B2%25E6%25B5%2581%25E6%25B5%2581%25E9%2587%258F-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzh-hans.zhgchg.li%2Fposts%2Fzrealm-dev%2Favplayer-%25E6%259C%25AC%25E5%259C%25B0-cache-%25E5%25AE%259E%25E4%25BD%259C%25E6%2594%25BB%25E7%2595%25A5-%25E4%25BD%25BF%25E7%2594%25A8-avassetresourceloaderdelegate-%25E8%258A%2582%25E7%259C%2581-ios-%25E9%259F%25B3%25E4%25B9%2590%25E4%25B8%25B2%25E6%25B5%2581%25E6%25B5%2581%25E9%2587%258F-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="复制连结" data-title-succeed="连结已成功复制！" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">最近更新</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/app-store-connect-api-webhook-%E4%B8%B2%E6%8E%A5-%E6%8F%90%E5%8D%87-ios-ci-cd-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%95%88%E7%8E%87%E4%B8%8E%E9%80%9A%E7%9F%A5%E6%B5%81%E7%A8%8B-7c0974856393/">CI/CD 使用 App Store Connect API Webhook 串接自动化工作流程</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ci-cd-%E6%98%AF%E4%BB%80%E4%B9%88-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A8%B3%E5%AE%9A%E5%BC%80%E5%8F%91%E5%9B%A2%E9%98%9F%E7%9A%84%E5%85%B3%E9%94%AE%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%B7%A5%E5%85%B7%E9%80%89%E6%8B%A9-c008a9e8ceca/">CI/CD 实战指南（一）：CI/CD 是什么？如何透过 CI/CD 打造稳定高效的开发团队？工具选择？</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/google-apps-script-web-app-%E6%89%93%E9%80%A0-github-action-ci-cd-%E8%87%AA%E8%AE%A2%E8%A1%A8%E5%8D%95%E6%8F%90%E5%8D%87%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87-4cb4437818f2/">使用 Google Apps Script Web App 表单串接 Github Action CI/CD 工作</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/github-action-%E5%85%8D%E8%B4%B9%E9%83%A8%E7%BD%B2-zreviewtender-app-%E5%95%86%E5%9F%8E%E8%AF%84%E4%BB%B7%E7%9B%91%E6%8E%A7%E6%9C%BA%E5%99%A8%E4%BA%BA-%E4%B8%89%E6%AD%A5%E9%AA%A4%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B-0095528cf875/">Quick Start! Github Action x ZReviewTender 免费快速部署你的 App 商城评价监控机器人</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/">iOS Timer 与 DispatchSourceTimer 如何选择与安全的使用?</a></ul></section><section><h2 class="panel-heading">热门标签</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E9%96%8B%E7%AE%B1/">開箱</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章节目录 🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">延伸阅读</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/avplayer-%E8%BE%B9%E6%92%AD%E8%BE%B9-cache-%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98-ios-%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1609856872" data-df="YYYY 年 M 月 D 日" > 2021 年 01 月 05 日 </time><h4 class="pt-0 my-2">AVPlayer 边播边 Cache 技术实战｜iOS 本地缓存优化攻略</h4><div class="text-muted"><p>针对 iOS 开发者面临 AVPlayer 播放时缓存不足问题，解析 AVAssetResourceLoaderDelegate 实作技巧，有效提升播放流畅度与本地缓存效率，减少重复下载与延迟，打造稳定音乐与影片播放器体验。</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1586365937" data-df="YYYY 年 M 月 D 日" > 2020 年 04 月 09 日 </time><h4 class="pt-0 my-2">iOS HLS Cache 实作全攻略｜AVPlayer 串流边播边快取技术解析</h4><div class="text-muted"><p>针对 iOS AVPlayer 播放 HLS m3u8 串流时无法拦截快取的痛点，深入分析多种快取方案，从 AVAssetResourceLoaderDelegate 到 Reverse Proxy Server，揭示技术瓶颈与可行解法，助你优化串流体验并有效节省伺服器与流量成本。</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/ios-wkwebview-%E9%A2%84%E8%BD%BD%E4%B8%8E-cache-%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF-%E6%8F%90%E5%8D%87%E9%A1%B5%E9%9D%A2%E8%BD%BD%E5%85%A5%E9%80%9F%E5%BA%A6%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90-5033090c18ba/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1722160385" data-df="YYYY 年 M 月 D 日" > 2024 年 07 月 28 日 </time><h4 class="pt-0 my-2">iOS WKWebView 页面与档案资源 Preload 预载 / Cache 缓存研究</h4><div class="text-muted"><p>iOS WKWebView 预先下载与缓存资源提升页面载入速度研究。</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/avplayer-%E8%BE%B9%E6%92%AD%E8%BE%B9-cache-%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98-ios-%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/" class="btn btn-outline-primary" aria-label="上一篇" ><p>AVPlayer 边播边 Cache 技术实战｜iOS 本地缓存优化攻略</p></a> <a href="/posts/zrealm-dev/ios-%E8%B7%A8%E5%B9%B3%E5%8F%B0%E5%B8%90%E5%8F%B7%E5%AF%86%E7%A0%81%E6%95%B4%E5%90%88-%E6%8F%90%E5%8D%87-app-%E4%B8%8E%E7%BD%91%E7%AB%99%E7%99%BB%E5%85%A5%E4%BD%93%E9%AA%8C-%E5%BF%AB%E9%80%9F%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%A5%E5%AF%86%E7%A0%81-948ed34efa09/" class="btn btn-outline-primary" aria-label="下一篇" ><p>iOS 跨平台帐号密码整合加强登入体验</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="除非另有注明，本网站上的所有文章皆由作者依据 创用 CC 姓名标示 4.0 国际授权条款（CC BY 4.0）授权使用。" >版权所有。</span> <br/> 最后更新时间:2025-12-31 11:06:15 +08:00</p><p>本站使用 <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> 主题建置于 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>。<br/> Medium 文章由 <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a> 转换而成。</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">热门标签</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E9%96%8B%E7%AE%B1/">開箱</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">发现有新的内容版本。</p><button type="button" class="btn btn-primary" aria-label="Update"> 更新 </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'zh-CN';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli-zh-hans.github.io', 'data-repo-id': 'R_kgDOQwFqjA', 'data-category': 'General', 'data-category-id': 'DIC_kwDOQwFqjM4C0UN-', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">找不到符合的结果。</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
